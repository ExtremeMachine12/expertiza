<% child_nodes = node.get_children(@sortvar,@sortorder,session[:user].id,@show,@search) %>
<%
  @student_full_names = []
  @student_email = []
  @student_names = []
  @student_count = 0
  @student_ids = []
  child_nodes.each_with_index do |child_node,index|
    child_node_name = child_node.get_name(session[:ip])
    if child_node_name.include?("(Mentor)")
      child_node_name = child_node_name.gsub(" (Mentor)", "")
    end
    @user = User.get_user_details(child_node_name)
    @full_name = @user.fullname.gsub(/(\d+),\s*(\w+)/, '\2 \1')
    if child_node.get_name(session[:ip]).include?("(Mentor)")
      @ta_name = @full_name
    else
      @student_full_names << @full_name
      @student_email << @user.email
      @student_names << @user.name
      @student_ids << child_node.node_object_id
    end
  end

  @student_count = @student_names.length
  while @student_names.length < 3
    @student_names << ""
  end
  @combined_full_names = @student_full_names.join(", ")
  @combined_emails = @student_email.join(", ")
%>

<%= @combined_names %>

<%# unless @student_count == 0 %>
  <tr
    <% if rowtype != nil %>class="<%= rowtype %>" id="<%= prefix %>"
    <% elsif prefix != nil %>id="<%= prefix %>" style="display: none;" name="team member"
    <% end %>
  >
    <td>
      <%= prefix %>
    </td>
    <td style="max-width: 200px">
      <%= @combined_full_names %>
    </td>
    <% @student_names.each_with_index do |name, idx| %>
      <% if not name.empty? %>
        <td><%= name %> <br />
          <%= link_to image_tag("delete_icon.png", :border=>0, :alt => "Delete Team User", :title => "Delete Team User"), :controller=>'teams_users', :action=>'delete', :id => @student_ids[idx] %>
        </td>
      <% else %>
        <td></td>
      <% end %>
    <% end %>
    <td style="max-width: fit-content">
      <%= @combined_emails %>
    </td>
    <% if @student_count == 3 %>
      <td>
        <%= @ta_name %>
      </td>
    <% else %>
      <td></td>
    <% end %>
    <%= render :partial => '/tree_display/actions/'+node.get_partial_name,
               :locals => {:node => node} %>
    <td>
      <input style="max-width: 80px" />
    </td>
    <td>
      <input style="max-width: 80px" />
    </td>
    <td>
      <input style="max-width: 80px" />
    </td>
    <td id="add_row_<%= prefix %>" style="cursor:pointer;">
      <%= image_tag("plus.png", :border=>0, :alt => "Add new date column", :title => "Add new date column") %>
    </td>
  </tr>
<%# end %>

<script>
    var addRow = document.getElementById(`add_row_<%= prefix %>`);
    addRow.addEventListener('click', function() {
        var thRow = document.getElementById('header')
        var thElements = thRow.getElementsByTagName('th');

        var count = -1;

        for (var i = 0; i < thElements.length; i++) {
            if (thElements[i].textContent.includes('mtg.')) {
                count++;
            }
        }

        var newth = document.createElement('th');
        newth.innerText = `${count + 1}th mtg.`
        thRow.insertBefore(newth, thRow.lastElementChild);

        var newTd = document.createElement('td');
        var input = document.createElement('input');
        input.setAttribute('style', 'max-width: 80px');
        newTd.appendChild(input);

        var table = document.getElementById('mentored_assignment_table');
        var rows = table.getElementsByTagName('tr');

        for (var i = 1; i < rows.length; i++) {
            var lastTdIndex = rows[i].cells.length - 1;
            var lastTd = rows[i].cells[lastTdIndex];
            rows[i].insertBefore(newTd.cloneNode(true), lastTd);
        }
    })
</script>